---
- name: Ensure Oh My ZSH repo exists
  ansible.builtin.git:
    repo: "https://github.com/ohmyzsh/ohmyzsh.git"
    dest: ~/.oh-my-zsh
    depth: 1
    update: false

- name: Ensure custom oh-my-zsh theme exists
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes/{{ item }}"
    mode: "0644"
  loop:
    - bart.zsh-theme
  become: false

- name: Git pull virtualenv-autodetect
  ansible.builtin.git:
    repo: https://github.com/RobertDeRose/virtualenv-autodetect.git
    dest: "{{ ansible_env.HOME }}/git/virtualenv-autodetect"
    update: true

- name: Git pull zsh-autosuggestions
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-autosuggestions.git
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
    depth: 1
    update: true

- name: Git pull zsh-syntax-highlighting
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
    depth: 1
    update: true

- name: Add poetry zsh plugin directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/poetry"
    state: directory
    mode: "0755"
  tags: poetry

- name: Install Poetry for oh-my-zsh
  ansible.builtin.shell: ~/.local/bin/poetry completions zsh > {{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/poetry/_poetry
  args:
    creates: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/poetry/_poetry"
  tags: poetry

- name: Git pull fzf
  ansible.builtin.git:
    repo: https://github.com/junegunn/fzf.git
    dest: "{{ ansible_env.HOME }}/git/fzf"
    depth: 1
    update: true
  tags: fzf

- name: Install fzf
  ansible.builtin.command: "{{ ansible_env.HOME }}/git/fzf/install --all"
  args:
    creates: "{{ ansible_env.HOME }}/.fzf.zsh"
  tags: fzf

- name: Create the .zshrc_local
  when: ohmyzsh_plugins is defined
  block:
    - name: Ensure the .zshrc_local file exists
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.zshrc_local"
        state: touch
        mode: 0600
        modification_time: preserve
        access_time: preserve

    - name: Fill the .zshrc_local
      ansible.builtin.blockinfile:
        path: "{{ ansible_env.HOME }}/.zshrc_local"
        block: |
          plugins=({{ ohmyzsh_plugins }})
